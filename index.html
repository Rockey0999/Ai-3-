<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodMirror Pro | AI Detection</title>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root { --neon: #00ff88; --bg: #0d1117; --card: #161b22; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        .main-frame { max-width: 900px; margin: auto; border: 1px solid #30363d; border-radius: 20px; padding: 30px; background: var(--card); box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--neon); padding-bottom: 10px; margin-bottom: 20px; }
        
        /* Camera Container */
        .camera-container { position: relative; width: 100%; height: 450px; background: #000; border-radius: 15px; overflow: hidden; border: 2px solid #30363d; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* UI Overlays */
        .hud-top { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); padding: 10px; border-left: 3px solid var(--neon); font-family: monospace; }
        .scanning-bar { position: absolute; width: 100%; height: 2px; background: var(--neon); top: 0; animation: scan 4s linear infinite; box-shadow: 0 0 10px var(--neon); pointer-events: none; }
        
        /* Analysis Results */
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
        .stat-box { background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; }
        .label { color: #8b949e; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
        .value { color: var(--neon); font-size: 1.6em; font-weight: bold; margin-top: 5px; transition: all 0.5s ease; }
        
        #advice-area { margin-top: 20px; background: rgba(0, 255, 136, 0.05); border: 1px solid var(--neon); padding: 20px; border-radius: 12px; color: #fff; line-height: 1.6; }

        @keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
        #loading-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div style="width: 50px; height: 50px; border: 5px solid #30363d; border-top-color: var(--neon); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <h2 style="margin-top: 20px;">CALIBRATING AI MODELS...</h2>
    <p style="color: #8b949e;">Please ensure your camera is connected.</p>
</div>

<div class="main-frame">
    <div class="header">
        <div style="font-size: 24px; font-weight: 800;">MOOD<span style="color:var(--neon)">MIRROR</span> AI</div>
        <div style="color: #8b949e; font-size: 12px;">SYSTEM STATUS: <span style="color:var(--neon)">OPTIMAL</span></div>
    </div>

    <div class="camera-container">
        <video id="webcam" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
        <div class="scanning-bar"></div>
        <div class="hud-top">
            SUBJECT ID: 2025-STUDENT<br>
            TRACKING: <span id="track-status" style="color:red">OFFLINE</span>
        </div>
    </div>

    <div class="result-grid">
        <div class="stat-box">
            <div class="label">Detected Emotion</div>
            <div id="val-emotion" class="value">---</div>
        </div>
        <div class="stat-box">
            <div class="label">Inference Accuracy</div>
            <div id="val-conf" class="value">0.0%</div>
        </div>
    </div>

    <div id="advice-area">
        <strong style="color:var(--neon)">AI STUDY ADVICE:</strong> <span id="val-advice">Awaiting facial recognition data...</span>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const overlay = document.getElementById('overlay');
    const trackStatus = document.getElementById('track-status');
    
    // Memory to prevent "shuffling" (Stability Logic)
    let lastEmotion = "";
    let emotionCount = 0;
    const SMOOTHING_THRESHOLD = 5; // Must detect same emotion 5 times to change text

    async function init() {
        const MODEL_URL = 'https://vladmandic.github.io/face-api/model/';
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            document.getElementById('loading-screen').style.display = 'none';
        } catch (e) {
            document.querySelector('#loading-screen h2').innerText = "ERROR: Camera Blocked";
        }
    }

    function updateLogic(emotion) {
        // Only update if it's a "solid" detection to slow down dynamic changes
        if (emotion === lastEmotion) {
            emotionCount++;
        } else {
            lastEmotion = emotion;
            emotionCount = 0;
            return; // Wait for stabilization
        }

        if (emotionCount === SMOOTHING_THRESHOLD) {
            document.getElementById('val-emotion').innerText = emotion.toUpperCase();
            
            // Reference: MoodMirror.pdf Study Optimization Table
            const adviceMap = {
                'happy': "ðŸš€ FLOW STATE: Peak efficiency detected. Continue with high-priority tasks.",
                'sad': "âš ï¸ FATIGUE: Signs of cognitive exhaustion. Take a 15-minute hydration break.",
                'angry': "ðŸ”¥ STRESS: High tension detected. Switch to a simpler task or listen to music.",
                'neutral': "âœ… STEADY: Focused learning detected. Keep maintaining this pace.",
                'surprised': "ðŸ’¡ ENGAGED: Curiosity spike detected. Perfect time for deep research."
            };
            document.getElementById('val-advice').innerText = adviceMap[emotion] || "Maintain study rhythm.";
        }
    }

    video.addEventListener('play', () => {
        const displaySize = { width: video.clientWidth, height: video.clientHeight };
        faceapi.matchDimensions(overlay, displaySize);

        setInterval(async () => {
            const detect = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                                          .withFaceExpressions();
            
            const ctx = overlay.getContext('2d');
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            if (detect) {
                trackStatus.innerText = "ONLINE";
                trackStatus.style.color = "var(--neon)";
                
                // Get Confidence
                const conf = (detect.detection.score * 100).toFixed(1);
                document.getElementById('val-conf').innerText = conf + "%";

                // Get Top Emotion
                const top = Object.keys(detect.expressions).reduce((a, b) => detect.expressions[a] > detect.expressions[b] ? a : b);
                updateLogic(top);

                // Draw Box
                const resized = faceapi.resizeResults(detect, displaySize);
                faceapi.draw.drawDetections(overlay, resized);
            } else {
                trackStatus.innerText = "LOST";
                trackStatus.style.color = "red";
            }
        }, 150); // 150ms interval for real-time tracking
    });

    init();
</script>
<style> @keyframes spin { 100% { transform: rotate(360deg); } } </style>
</body>
</html>
