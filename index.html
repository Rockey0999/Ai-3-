<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodMirror AI | Real-Time Dashboard</title>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root { --neon: #00ff88; --bg: #0d1117; --panel: #161b22; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: auto; background: var(--panel); padding: 25px; border-radius: 20px; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Professional Video Section */
        .video-box { position: relative; width: 100%; height: 450px; background: #000; border-radius: 12px; overflow: hidden; border: 2px solid #30363d; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* Real-Time HUD */
        .hud { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 5px; border-left: 3px solid var(--neon); text-align: left; font-family: monospace; font-size: 12px; pointer-events: none; }
        
        /* Results Section */
        .results { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
        .card { background: #0d1117; padding: 15px; border-radius: 12px; border: 1px solid #30363d; }
        .label { color: #8b949e; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
        .val { color: var(--neon); font-size: 1.8em; font-weight: bold; margin-top: 5px; }

        #advice-area { margin-top: 20px; padding: 20px; background: rgba(0, 255, 136, 0.05); border: 1px solid var(--neon); border-radius: 12px; line-height: 1.6; text-align: left; }
        
        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #30363d; border-top-color: var(--neon); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <h2 style="margin-top:20px;">INITIALIZING MOODMIRROR AI...</h2>
    <p style="color:#8b949e;">Connecting to Global Inference Models</p>
</div>

<div class="container">
    <h1 style="margin:0 0 10px 0;">MOOD<span style="color:var(--neon)">MIRROR</span></h1>
    <p style="color:#8b949e; margin-bottom: 20px;">Class 12 AI Project: Real-Time Study Optimization</p>

    <div class="video-box">
        <video id="webcam" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
        <div class="hud">
            SYSTEM: ONLINE<br>
            TRACKING: <span id="status">SCANNING...</span><br>
            FPS: <span id="fps">0</span>
        </div>
    </div>

    <div class="results">
        <div class="card">
            <div class="label">Primary Emotion</div>
            <div id="res-emo" class="val">---</div>
        </div>
        <div class="card">
            <div class="label">Inference Accuracy</div>
            <div id="res-conf" class="val">0.0%</div>
        </div>
    </div>

    <div id="advice-area">
        <strong style="color:var(--neon)">ðŸ§  AI STUDY ADVICE:</strong> 
        <span id="res-advice">Please face the camera to begin real-time analysis.</span>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const overlay = document.getElementById('overlay');
    
    // Stability Logic (Prevents flickering results)
    let lastEmotion = "";
    let stabilityCounter = 0;
    const STABILITY_REQUIRED = 4; // Emotion must be detected 4 times before UI updates

    async function setupAI() {
        const MODEL_URL = 'https://vladmandic.github.io/face-api/model/';
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            document.getElementById('loading').style.display = 'none';
        } catch (err) {
            document.querySelector('#loading h2').innerText = "CAMERA ACCESS BLOCKED";
            document.querySelector('#loading p').innerText = "Please enable camera permissions and use HTTPS.";
        }
    }

    function processMood(emotion) {
        if (emotion === lastEmotion) {
            stabilityCounter++;
        } else {
            lastEmotion = emotion;
            stabilityCounter = 0;
            return;
        }

        if (stabilityCounter === STABILITY_REQUIRED) {
            document.getElementById('res-emo').innerText = emotion.toUpperCase();
            
            // Logic mapping from Page 37 of your MoodMirror.pdf
            const adviceMap = {
                'happy': "ðŸš€ FLOW STATE: Peak efficiency detected. Continue with high-priority tasks.",
                'sad': "âš ï¸ FATIGUE: Signs of cognitive exhaustion. Take a 15-minute break.",
                'angry': "ðŸ”¥ STRESS: High tension detected. Switch to a simpler task or listen to music.",
                'neutral': "âœ… STEADY: Focused learning detected. Keep maintaining this pace.",
                'surprised': "ðŸ’¡ ENGAGED: Curiosity detected! Perfect time for active recall."
            };
            document.getElementById('res-advice').innerText = adviceMap[emotion] || "Keep focus.";
        }
    }

    video.addEventListener('play', () => {
        const displaySize = { width: video.clientWidth, height: video.clientHeight };
        faceapi.matchDimensions(overlay, displaySize);

        let lastTime = Date.now();

        setInterval(async () => {
            const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224 }))
                                            .withFaceExpressions();
            
            const ctx = overlay.getContext('2d');
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            if (detections) {
                document.getElementById('status').innerText = "LOCKED";
                document.getElementById('status').style.color = "var(--neon)";
                
                // FPS Calc
                const now = Date.now();
                document.getElementById('fps').innerText = Math.round(1000 / (now - lastTime));
                lastTime = now;

                // Accuracy
                document.getElementById('res-conf').innerText = (detections.detection.score * 100).toFixed(1) + "%";

                // Emotion Extraction
                const expressions = detections.expressions;
                const top = Object.keys(expressions).reduce((a, b) => expressions[a] > expressions[b] ? a : b);
                processMood(top);

                // Real-time Drawing
                const resized = faceapi.resizeResults(detections, displaySize);
                faceapi.draw.drawDetections(overlay, resized);
            } else {
                document.getElementById('status').innerText = "SEARCHING...";
                document.getElementById('status').style.color = "red";
            }
        }, 150); // High-speed 150ms interval
    });

    setupAI();
</script>
</body>
</html>
